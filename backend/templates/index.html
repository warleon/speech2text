<!DOCTYPE html>
<html>
  <head>
    <title>Whisper S2T Transcription</title>
    <style>
      table {
        border-collapse: collapse;
        width: 100%;
      }
      th,
      td {
        border: 1px solid #ddd;
        padding: 8px;
        vertical-align: top;
      }
      th {
        background-color: #f2f2f2;
      }
      #copyBtn {
        margin-top: 10px;
      }
    </style>
  </head>
  <body>
    <h1>Whisper S2T Web App</h1>
    <form id="transcribeForm" enctype="multipart/form-data">
      <label>Audio File:</label>
      <input
        type="file"
        name="audio_file"
        accept="audio/*"
        required
      /><br /><br />

      <label>Language:</label>
      <select name="lang_codes[]" required>
        <option value="en" selected>English</option>
        <option value="es">Spanish</option>
        <option value="fr">French</option>
        <option value="de">German</option>
        <option value="it">Italian</option>
        <option value="pt">Portuguese</option></select
      ><br /><br />

      <button type="submit">Start Transcription</button>
    </form>

    <h2>Output:</h2>
    <table id="outputTable" style="display: none">
      <thead>
        <tr>
          <th>Start Time (s)</th>
          <th>End Time (s)</th>
          <th>Text</th>
        </tr>
      </thead>
      <tbody id="outputBody"></tbody>
    </table>
    <button id="copyBtn" style="display: none">Copy Table</button>

    <script>
      document.getElementById("transcribeForm").onsubmit = async function (e) {
        e.preventDefault();
        const formData = new FormData(this);

        const response = await fetch("/transcribe", {
          method: "POST",
          body: formData,
        });

        const result = await response.json();

        const table = document.getElementById("outputTable");
        const tbody = document.getElementById("outputBody");
        const copyBtn = document.getElementById("copyBtn");

        tbody.innerHTML = "";

        if (Array.isArray(result)) {
          result.forEach((row) => {
            const tr = document.createElement("tr");
            tr.innerHTML = `<td>${row.start_time}</td><td>${row.end_time}</td><td>${row.text}</td>`;
            tbody.appendChild(tr);
          });
          table.style.display = "table";
          copyBtn.style.display = "inline-block";
        } else {
          tbody.innerHTML = `<tr><td colspan="3">${
            result.error || "Unknown error"
          }</td></tr>`;
          table.style.display = "table";
          copyBtn.style.display = "none";
        }
      };

      document.getElementById("copyBtn").onclick = function () {
        const rows = document.querySelectorAll("#outputTable tr");
        let text = "";
        rows.forEach((row) => {
          const cols = row.querySelectorAll("th, td");
          let rowText = [];
          cols.forEach((col) => rowText.push(col.innerText));
          text += rowText.join("\t") + "\n";
        });

        navigator.clipboard
          .writeText(text)
          .then(() => {
            alert("Table copied to clipboard!");
          })
          .catch((err) => {
            alert("Failed to copy table: " + err);
          });
      };
    </script>
  </body>
</html>
